@page "/diagnostics/{cacheId}"
@using DiagnosticsTool.Services
@using DiagnosticsTool.Models.Responses
@using OpenTraceability.Queries.Diagnostics
@using System.Net.Http
@inject IDiagnosticsEnvelopeCache Cache
@inject NavigationManager Nav

@code {
    [Parameter] public string cacheId { get; set; } = string.Empty;
    IDiagnosticsEnvelope? envelope;
    DateTime createdUtc;

    protected override void OnParametersSet()
    {
        if (string.IsNullOrWhiteSpace(cacheId)) return;
        if (Cache.TryGet(cacheId, out var env, out var ts))
        {
            envelope = env;
            createdUtc = ts;
        }
    }

    string Json(object? o) => o == null ? "null" : System.Text.Json.JsonSerializer.Serialize(o, new System.Text.Json.JsonSerializerOptions { WriteIndented = true });
    string FormatHttpRequest(HttpRequestMessage? request) => request?.ToString() ?? "null";
    string FormatHttpResponse(HttpResponseMessage? response) => response?.ToString() ?? "null";
    string FormatTimelineTimestamp(DateTime start, DateTime end)
    {
        var reference = end != default ? end : start;
        if (reference == default)
        {
            return "N/A";
        }

        return reference.ToLocalTime().ToString("g");
    }

    string FormatDuration(DateTime start, DateTime end)
    {
        if (start == default || end == default)
        {
            return "N/A";
        }

        var duration = end - start;
        if (duration.TotalMilliseconds < 0)
        {
            duration = TimeSpan.Zero;
        }

        return $"{duration.TotalMilliseconds:n0} ms";
    }

    static IEnumerable<DiagnosticsValidationResult> SortValidations(IEnumerable<DiagnosticsValidationResult> validations)
    {
        return validations
            .OrderBy(v => v.Level switch
            {
                OpenTraceability.LogLevel.Error => 0,
                OpenTraceability.LogLevel.Warning => 1,
                OpenTraceability.LogLevel.Info => 2,
                OpenTraceability.LogLevel.Debug => 3,
                _ => 4
            })
            .ThenBy(v => v.Type.ToString());
    }

    static string ValidationLevelClass(OpenTraceability.LogLevel level) => level switch
    {
        OpenTraceability.LogLevel.Error => "level-error",
        OpenTraceability.LogLevel.Warning => "level-warning",
        OpenTraceability.LogLevel.Info => "level-info",
        OpenTraceability.LogLevel.Debug => "level-verbose",
        _ => "level-default"
    };
}

@if (envelope == null)
{
    <div class="card not-found-state">
        <h2>Diagnostics Not Found</h2>
        <p>No cached diagnostics found for ID <code>@cacheId</code>.</p>
        <div>
            <button class="btn ghost" @onclick="@(() => Nav.NavigateTo("/"))">Back to dashboard</button>
        </div>
    </div>
}
else
{
    <div class="page-header">
        <div class="page-header-copy">
            <h1 class="page-title">Diagnostics Report</h1>
            <div class="meta">
                <span>ID <code>@cacheId</code></span>
                <span>Captured @createdUtc.ToString("u")</span>
                <span>Schema Errors: @(envelope.HasSchemaErrors ? "Yes" : "No")</span>
            </div>
        </div>
        <div class="page-header-actions">
            <button class="btn ghost" @onclick="@(() => Nav.NavigateTo("/"))">Back to dashboard</button>
        </div>
    </div>

    <section class="card">
        <h2 class="section-title">Summary</h2>
        <div class="metric-grid">
            <div class="metric-card">
                <div class="metric-label">Requests</div>
                <div class="metric-value">@envelope.Diagnostics.Requests.Count</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Validations</div>
                <div class="metric-value">@envelope.Diagnostics.Validations.Count</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Schema Errors</div>
                <div class="metric-value @(envelope.HasSchemaErrors ? "bad" : "good")">@(envelope.HasSchemaErrors ? "Yes" : "No")
                </div>
            </div>
        </div>
    </section>

    <section class="card card-compact">
        <h2 class="section-title">Requests (chronological)</h2>
        @if (envelope.Diagnostics.Requests.Count == 0)
        {
            <p class="muted">No requests recorded.</p>
        }
        else
        {
            <ol class="accordion timeline">
                @foreach (var r in envelope.Diagnostics.Requests.Select((r, i) => new { r, i }))
                {
                    <li class="timeline-item">
                        <div class="timeline-axis">
                            <span class="timeline-dot"></span>
                            <div class="timeline-meta">
                                <span class="timeline-timestamp">@FormatTimelineTimestamp(r.r.Start, r.r.End)</span>
                                <span class="timeline-duration">@FormatDuration(r.r.Start, r.r.End)</span>
                            </div>
                        </div>
                        <div class="timeline-content">
                            <details open>
                                <summary><span class="badge index">@(@r.i + 1)</span>@(r.r.Title)</summary>
                                <pre class="code-block">@Json(r.r.RequestOptions)</pre>
                                <div class="http-exchange">
                                    <h5>HTTP Request</h5>
                                    <pre class="code-block">@FormatHttpRequest(r.r.HttpRequest)</pre>
                                    <h5>HTTP Response</h5>
                                    <pre class="code-block">@FormatHttpResponse(r.r.HttpResponse)</pre>
                                    <h5>Response Body</h5>
                                    <pre class="code-block">@(string.IsNullOrWhiteSpace(r.r.ResponseBody) ? "(empty)" : r.r.ResponseBody)</pre>
                                </div>
                                @if (r.r.Validations.Any())
                                {
                                    <div class="validations">
                                        <h5>Request Validations (@r.r.Validations.Count)</h5>
                                        <ul>
                                            @foreach (var v in SortValidations(r.r.Validations))
                                            {
                                                <li class="validation @ValidationLevelClass(v.Level) @(v.Type.ToString().ToLower())">
                                                    <span class="validation-level">@v.Level</span>
                                                    <span class="validation-type">@v.Type</span>
                                                    <span class="validation-message">@v.Message</span>
                                                </li>
                                            }
                                        </ul>
                                    </div>
                                }
                            </details>
                        </div>
                    </li>
                }
            </ol>
        }
    </section>

    <section class="card card-compact">
        <h2 class="section-title">Global Validations</h2>
        @if (!envelope.Diagnostics.Validations.Any())
        {
            <p class="muted">No validations recorded.</p>
        }
        else
        {
            <ul class="validation-list">
                @foreach (var v in SortValidations(envelope.Diagnostics.Validations))
                {
                    <li class="validation @ValidationLevelClass(v.Level) @(v.Type.ToString().ToLower())">
                        <span class="validation-level">@v.Level</span>
                        <span class="validation-type">@v.Type</span>
                        <span class="validation-message">@v.Message</span>
                    </li>
                }
            </ul>
        }
    </section>

    <section class="card card-compact">
        <h2 class="section-title">Raw Data (Envelope Data)</h2>
        <pre class="code-block">@Json(envelope.DataObject)</pre>
    </section>
}